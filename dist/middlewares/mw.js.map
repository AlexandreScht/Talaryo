{"version":3,"sources":["../../src/middlewares/mw.ts"],"sourcesContent":["import { ExpiredSessionError } from '@/exceptions';\nimport config from '@config';\nimport type { DataStoredInToken, TokenUser } from '@interfaces/auth';\nimport type { RequestWithAuth, ctx } from '@interfaces/request';\nimport UsersServiceFile from '@services/users';\nimport deepmerge from 'deepmerge';\nimport { NextFunction, Request, Response } from 'express';\nimport { verify } from 'jsonwebtoken';\nimport Container from 'typedi';\nconst { security } = config;\n\nconst getAuthorization = (req: Request) => {\n  const coockie = req.cookies['Authorization'];\n  if (coockie) return coockie;\n\n  const header = req.header('Authorization');\n  if (header) return header.split('Bearer ')[1];\n\n  return null;\n};\n\nconst getUser = (Authorization: string): [boolean | Error, TokenUser?] => {\n  try {\n    const data = verify(Authorization, security.session.SESSION_SECRET) as DataStoredInToken;\n    const user = {\n      ...data.user,\n      sessionId: Number.parseInt(data.user.sessionId),\n    };\n    return [false, user];\n  } catch (error) {\n    return [error];\n  }\n};\n\nconst mw =\n  (middlewaresHandler: any[]) =>\n  async (req: RequestWithAuth, res: Response, nextExpress: NextFunction): Promise<void> => {\n    const locals = {};\n    const session: Partial<TokenUser> = {};\n    let handlerIndex = 0;\n    const ctx: ctx = {\n      req,\n      res,\n      get locals() {\n        return locals;\n      },\n      set locals(newLocals) {\n        Object.assign(locals, deepmerge(locals, newLocals));\n      },\n      get session() {\n        return session;\n      },\n      set session(newSession) {\n        Object.assign(session, deepmerge(session, newSession));\n      },\n      next: async err => {\n        try {\n          if (err && err instanceof Error) {\n            nextExpress(err);\n          } else {\n            const handler = middlewaresHandler[handlerIndex];\n            handlerIndex += 1;\n            await handler(ctx);\n          }\n        } catch (error) {\n          nextExpress(error);\n        }\n      },\n    };\n    try {\n      const UserServices = Container.get(UsersServiceFile);\n      const Authorization = getAuthorization(req);\n      if (Authorization) {\n        const [err, user] = getUser(Authorization);\n\n        if (err) {\n          throw new ExpiredSessionError();\n        }\n        await UserServices.checkRefreshToken(user);\n        ctx.session = user;\n      }\n\n      await ctx.next();\n    } catch (err) {\n      nextExpress(err);\n    }\n  };\n\nexport default mw;\n"],"names":["security","config","getAuthorization","req","coockie","cookies","header","split","getUser","Authorization","data","verify","session","SESSION_SECRET","user","sessionId","Number","parseInt","error","mw","middlewaresHandler","res","nextExpress","locals","handlerIndex","ctx","newLocals","Object","assign","deepmerge","newSession","next","err","Error","handler","UserServices","Container","get","UsersServiceFile","ExpiredSessionError","checkRefreshToken"],"mappings":";;;;+BAwFA;;;eAAA;;;4BAxFoC;+DACjB;8DAGU;kEACP;8BAEC;+DACD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACtB,MAAM,EAAEA,QAAQ,EAAE,GAAGC,eAAM;AAE3B,MAAMC,mBAAmB,CAACC;IACxB,MAAMC,UAAUD,IAAIE,OAAO,CAAC,gBAAgB;IAC5C,IAAID,SAAS,OAAOA;IAEpB,MAAME,SAASH,IAAIG,MAAM,CAAC;IAC1B,IAAIA,QAAQ,OAAOA,OAAOC,KAAK,CAAC,UAAU,CAAC,EAAE;IAE7C,OAAO;AACT;AAEA,MAAMC,UAAU,CAACC;IACf,IAAI;QACF,MAAMC,OAAOC,IAAAA,oBAAM,EAACF,eAAeT,SAASY,OAAO,CAACC,cAAc;QAClE,MAAMC,OAAO,wCACRJ,KAAKI,IAAI;YACZC,WAAWC,OAAOC,QAAQ,CAACP,KAAKI,IAAI,CAACC,SAAS;;QAEhD,OAAO;YAAC;YAAOD;SAAK;IACtB,EAAE,OAAOI,OAAO;QACd,OAAO;YAACA;SAAM;IAChB;AACF;AAEA,MAAMC,KACJ,CAACC,qBACD,OAAOjB,KAAsBkB,KAAeC;QAC1C,MAAMC,SAAS,CAAC;QAChB,MAAMX,UAA8B,CAAC;QACrC,IAAIY,eAAe;QACnB,MAAMC,MAAW;YACftB;YACAkB;YACA,IAAIE,UAAS;gBACX,OAAOA;YACT;YACA,IAAIA,QAAOG,UAAW;gBACpBC,OAAOC,MAAM,CAACL,QAAQM,IAAAA,kBAAS,EAACN,QAAQG;YAC1C;YACA,IAAId,WAAU;gBACZ,OAAOA;YACT;YACA,IAAIA,SAAQkB,WAAY;gBACtBH,OAAOC,MAAM,CAAChB,SAASiB,IAAAA,kBAAS,EAACjB,SAASkB;YAC5C;YACAC,MAAM,OAAMC;gBACV,IAAI;oBACF,IAAIA,OAAOA,eAAeC,OAAO;wBAC/BX,YAAYU;oBACd,OAAO;wBACL,MAAME,UAAUd,kBAAkB,CAACI,aAAa;wBAChDA,gBAAgB;wBAChB,MAAMU,QAAQT;oBAChB;gBACF,EAAE,OAAOP,OAAO;oBACdI,YAAYJ;gBACd;YACF;QACF;QACA,IAAI;YACF,MAAMiB,eAAeC,eAAS,CAACC,GAAG,CAACC,cAAgB;YACnD,MAAM7B,gBAAgBP,iBAAiBC;YACvC,IAAIM,eAAe;gBACjB,MAAM,CAACuB,KAAKlB,KAAK,GAAGN,QAAQC;gBAE5B,IAAIuB,KAAK;oBACP,MAAM,IAAIO,+BAAmB;gBAC/B;gBACA,MAAMJ,aAAaK,iBAAiB,CAAC1B;gBACrCW,IAAIb,OAAO,GAAGE;YAChB;YAEA,MAAMW,IAAIM,IAAI;QAChB,EAAE,OAAOC,KAAK;YACZV,YAAYU;QACd;IACF;MAEF,WAAeb"}