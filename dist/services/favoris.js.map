{"version":3,"sources":["../../src/services/favoris.ts"],"sourcesContent":["import { ServicesError } from '@/exceptions';\nimport { favorisData, findFav } from '@/interfaces/favoris';\nimport { cheerioInfos } from '@/interfaces/scrapping';\nimport { FavoriModel } from '@models/favoris';\nimport type { Knex } from 'knex';\nimport { ConstraintViolationError } from 'objection';\nimport { Service } from 'typedi';\n\n@Service()\nclass FavorisServiceFile {\n  get getModel(): Knex<any, any[]> {\n    return FavoriModel.knex();\n  }\n\n  // ! A refaire\n  public async findAllUserFav(id: number, objects: cheerioInfos[]): Promise<Map<string, number>> {\n    try {\n      const links = [...new Set(objects.map(obj => obj.link))];\n      const favorites = await FavoriModel.query().where({ userId: id }).whereIn('link', links).select('link', 'favFolderId');\n\n      return new Map(favorites.map(fav => [fav.link, fav.favFolderId]));\n    } catch (error) {\n      throw new ServicesError();\n    }\n  }\n\n  public async getFavInFolder(limit: number, page: number, favFolderId: number): Promise<{ total: number; favoris: FavoriModel[] }> {\n    try {\n      const query = FavoriModel.query().where({ favFolderId, disabled: false });\n      const [{ count }] = await query.clone().limit(1).offset(0).count();\n      const total = Number.parseInt(count, 10);\n\n      const favoris = await query.modify('paginate', limit, page);\n      return { total, favoris };\n    } catch (error) {\n      throw new ServicesError();\n    }\n  }\n  public async getLastFav(userId: number): Promise<FavoriModel[]> {\n    try {\n      return await FavoriModel.query().where({ userId, disabled: false }).orderBy('id', 'desc').limit(3);\n    } catch (error) {\n      throw new ServicesError();\n    }\n  }\n\n  public async createFav(fav: favorisData, id: number): Promise<FavoriModel | boolean> {\n    try {\n      return await FavoriModel.query().insert({ ...fav, userId: id });\n    } catch (error) {\n      if (error instanceof ConstraintViolationError) {\n        return false;\n      }\n      throw new ServicesError();\n    }\n  }\n\n  public async removeFav({ favFolderId, link }: findFav): Promise<boolean> {\n    try {\n      const deletedRows = await FavoriModel.query().delete().where({\n        favFolderId,\n        link,\n      });\n      return !isNaN(deletedRows) && deletedRows > 0;\n    } catch (error) {\n      throw new ServicesError();\n    }\n  }\n}\n\nexport default FavorisServiceFile;\n"],"names":["FavorisServiceFile","getModel","FavoriModel","knex","findAllUserFav","id","objects","links","Set","map","obj","link","favorites","query","where","userId","whereIn","select","Map","fav","favFolderId","error","ServicesError","getFavInFolder","limit","page","disabled","count","clone","offset","total","Number","parseInt","favoris","modify","getLastFav","orderBy","createFav","insert","ConstraintViolationError","removeFav","deletedRows","delete","isNaN","Service"],"mappings":";;;;+BAsEA;;;eAAA;;;4BAtE8B;yBAGF;2BAEa;wBACjB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAGlBA,qBADN;IAEE,IAAIC,WAA6B;QAC/B,OAAOC,oBAAW,CAACC,IAAI;IACzB;IAEA,cAAc;IACd,MAAaC,eAAeC,EAAU,EAAEC,OAAuB,EAAgC;QAC7F,IAAI;YACF,MAAMC,QAAQ;mBAAI,IAAIC,IAAIF,QAAQG,GAAG,CAACC,CAAAA,MAAOA,IAAIC,IAAI;aAAG;YACxD,MAAMC,YAAY,MAAMV,oBAAW,CAACW,KAAK,GAAGC,KAAK,CAAC;gBAAEC,QAAQV;YAAG,GAAGW,OAAO,CAAC,QAAQT,OAAOU,MAAM,CAAC,QAAQ;YAExG,OAAO,IAAIC,IAAIN,UAAUH,GAAG,CAACU,CAAAA,MAAO;oBAACA,IAAIR,IAAI;oBAAEQ,IAAIC,WAAW;iBAAC;QACjE,EAAE,OAAOC,OAAO;YACd,MAAM,IAAIC,yBAAa;QACzB;IACF;IAEA,MAAaC,eAAeC,KAAa,EAAEC,IAAY,EAAEL,WAAmB,EAAsD;QAChI,IAAI;YACF,MAAMP,QAAQX,oBAAW,CAACW,KAAK,GAAGC,KAAK,CAAC;gBAAEM;gBAAaM,UAAU;YAAM;YACvE,MAAM,CAAC,EAAEC,KAAK,EAAE,CAAC,GAAG,MAAMd,MAAMe,KAAK,GAAGJ,KAAK,CAAC,GAAGK,MAAM,CAAC,GAAGF,KAAK;YAChE,MAAMG,QAAQC,OAAOC,QAAQ,CAACL,OAAO;YAErC,MAAMM,UAAU,MAAMpB,MAAMqB,MAAM,CAAC,YAAYV,OAAOC;YACtD,OAAO;gBAAEK;gBAAOG;YAAQ;QAC1B,EAAE,OAAOZ,OAAO;YACd,MAAM,IAAIC,yBAAa;QACzB;IACF;IACA,MAAaa,WAAWpB,MAAc,EAA0B;QAC9D,IAAI;YACF,OAAO,MAAMb,oBAAW,CAACW,KAAK,GAAGC,KAAK,CAAC;gBAAEC;gBAAQW,UAAU;YAAM,GAAGU,OAAO,CAAC,MAAM,QAAQZ,KAAK,CAAC;QAClG,EAAE,OAAOH,OAAO;YACd,MAAM,IAAIC,yBAAa;QACzB;IACF;IAEA,MAAae,UAAUlB,GAAgB,EAAEd,EAAU,EAAkC;QACnF,IAAI;YACF,OAAO,MAAMH,oBAAW,CAACW,KAAK,GAAGyB,MAAM,CAAC,wCAAKnB;gBAAKJ,QAAQV;;QAC5D,EAAE,OAAOgB,OAAO;YACd,IAAIA,iBAAiBkB,mCAAwB,EAAE;gBAC7C,OAAO;YACT;YACA,MAAM,IAAIjB,yBAAa;QACzB;IACF;IAEA,MAAakB,UAAU,EAAEpB,WAAW,EAAET,IAAI,EAAW,EAAoB;QACvE,IAAI;YACF,MAAM8B,cAAc,MAAMvC,oBAAW,CAACW,KAAK,GAAG6B,MAAM,GAAG5B,KAAK,CAAC;gBAC3DM;gBACAT;YACF;YACA,OAAO,CAACgC,MAAMF,gBAAgBA,cAAc;QAC9C,EAAE,OAAOpB,OAAO;YACd,MAAM,IAAIC,yBAAa;QACzB;IACF;AACF;AA3DMtB;IADL4C,IAAAA,eAAO;GACF5C;MA6DN,WAAeA"}