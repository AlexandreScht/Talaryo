{"version":3,"sources":["../../src/services/favFolders.ts"],"sourcesContent":["import { InvalidCredentialsError, ServicesError } from '@/exceptions';\nimport { FavFoldersModel } from '@/models/favFolders';\nimport { FavoriModel } from '@/models/favoris';\nimport type { Knex } from 'knex';\nimport { ConstraintViolationError } from 'objection';\nimport { Service } from 'typedi';\n\n@Service()\nclass FavorisFolderFile {\n  get getModel(): Knex<any, any[]> {\n    return FavFoldersModel.knex();\n  }\n\n  public async createFolder(name: string, userId: number): Promise<FavFoldersModel | boolean> {\n    try {\n      return await FavFoldersModel.query().insert({ name, userId });\n    } catch (error) {\n      if (error instanceof ConstraintViolationError) {\n        return false;\n      }\n      throw new ServicesError();\n    }\n  }\n\n  public async removeFavFolder(id: number): Promise<number> {\n    try {\n      await FavoriModel.query().where('favFolderId', id).delete();\n      return await FavFoldersModel.query().findById(id).delete();\n    } catch (error) {\n      console.log(error);\n\n      throw new ServicesError();\n    }\n  }\n  public async getFolderByName(name: string, userId: number): Promise<FavFoldersModel> {\n    try {\n      const folder = await FavFoldersModel.query().select('id').where({ name, userId }).first();\n      if (folder) {\n        return folder;\n      }\n    } catch (error) {\n      throw new ServicesError();\n    }\n    throw new InvalidCredentialsError();\n  }\n\n  public async getFavInFolders(\n    userId: number,\n    { limit, page, name }: { limit: number; page: number; name?: string },\n  ): Promise<{ total: number; folders: FavFoldersModel[] }> {\n    try {\n      let query = FavFoldersModel.query().where('favFolders.userId', userId);\n\n      if (name) {\n        query = query.where('name', 'like', `${name}%`);\n      }\n\n      const [{ count }] = await query.clone().limit(1).offset(0).count();\n      const total = Number.parseInt(count, 10);\n\n      const folders = await query\n        .clone()\n        .select('favFolders.id', 'favFolders.name')\n        .leftJoin('favoris', 'favFolders.id', 'favoris.favFolderId')\n        .andWhere(function () {\n          this.where('favoris.disabled', false).orWhereNull('favoris.disabled');\n        })\n        .groupBy('favFolders.id')\n        .count('favoris.id as itemsCount')\n        .modify('paginate', limit, page);\n\n      return { total, folders };\n    } catch (error) {\n      console.log(error);\n\n      throw new ServicesError();\n    }\n  }\n}\n\nexport default FavorisFolderFile;\n"],"names":["FavorisFolderFile","getModel","FavFoldersModel","knex","createFolder","name","userId","query","insert","error","ConstraintViolationError","ServicesError","removeFavFolder","id","FavoriModel","where","delete","findById","console","log","getFolderByName","folder","select","first","InvalidCredentialsError","getFavInFolders","limit","page","count","clone","offset","total","Number","parseInt","folders","leftJoin","andWhere","orWhereNull","groupBy","modify","Service"],"mappings":";;;;+BAgFA;;;eAAA;;;4BAhFuD;4BACvB;yBACJ;2BAEa;wBACjB;;;;;;;IAGlBA,oBADN;IAEE,IAAIC,WAA6B;QAC/B,OAAOC,2BAAe,CAACC,IAAI;IAC7B;IAEA,MAAaC,aAAaC,IAAY,EAAEC,MAAc,EAAsC;QAC1F,IAAI;YACF,OAAO,MAAMJ,2BAAe,CAACK,KAAK,GAAGC,MAAM,CAAC;gBAAEH;gBAAMC;YAAO;QAC7D,EAAE,OAAOG,OAAO;YACd,IAAIA,iBAAiBC,mCAAwB,EAAE;gBAC7C,OAAO;YACT;YACA,MAAM,IAAIC,yBAAa;QACzB;IACF;IAEA,MAAaC,gBAAgBC,EAAU,EAAmB;QACxD,IAAI;YACF,MAAMC,oBAAW,CAACP,KAAK,GAAGQ,KAAK,CAAC,eAAeF,IAAIG,MAAM;YACzD,OAAO,MAAMd,2BAAe,CAACK,KAAK,GAAGU,QAAQ,CAACJ,IAAIG,MAAM;QAC1D,EAAE,OAAOP,OAAO;YACdS,QAAQC,GAAG,CAACV;YAEZ,MAAM,IAAIE,yBAAa;QACzB;IACF;IACA,MAAaS,gBAAgBf,IAAY,EAAEC,MAAc,EAA4B;QACnF,IAAI;YACF,MAAMe,SAAS,MAAMnB,2BAAe,CAACK,KAAK,GAAGe,MAAM,CAAC,MAAMP,KAAK,CAAC;gBAAEV;gBAAMC;YAAO,GAAGiB,KAAK;YACvF,IAAIF,QAAQ;gBACV,OAAOA;YACT;QACF,EAAE,OAAOZ,OAAO;YACd,MAAM,IAAIE,yBAAa;QACzB;QACA,MAAM,IAAIa,mCAAuB;IACnC;IAEA,MAAaC,gBACXnB,MAAc,EACd,EAAEoB,KAAK,EAAEC,IAAI,EAAEtB,IAAI,EAAkD,EACb;QACxD,IAAI;YACF,IAAIE,QAAQL,2BAAe,CAACK,KAAK,GAAGQ,KAAK,CAAC,qBAAqBT;YAE/D,IAAID,MAAM;gBACRE,QAAQA,MAAMQ,KAAK,CAAC,QAAQ,QAAQ,CAAC,EAAEV,KAAK,CAAC,CAAC;YAChD;YAEA,MAAM,CAAC,EAAEuB,KAAK,EAAE,CAAC,GAAG,MAAMrB,MAAMsB,KAAK,GAAGH,KAAK,CAAC,GAAGI,MAAM,CAAC,GAAGF,KAAK;YAChE,MAAMG,QAAQC,OAAOC,QAAQ,CAACL,OAAO;YAErC,MAAMM,UAAU,MAAM3B,MACnBsB,KAAK,GACLP,MAAM,CAAC,iBAAiB,mBACxBa,QAAQ,CAAC,WAAW,iBAAiB,uBACrCC,QAAQ,CAAC;gBACR,IAAI,CAACrB,KAAK,CAAC,oBAAoB,OAAOsB,WAAW,CAAC;YACpD,GACCC,OAAO,CAAC,iBACRV,KAAK,CAAC,4BACNW,MAAM,CAAC,YAAYb,OAAOC;YAE7B,OAAO;gBAAEI;gBAAOG;YAAQ;QAC1B,EAAE,OAAOzB,OAAO;YACdS,QAAQC,GAAG,CAACV;YAEZ,MAAM,IAAIE,yBAAa;QACzB;IACF;AACF;AAtEMX;IADLwC,IAAAA,eAAO;GACFxC;MAwEN,WAAeA"}